# Attestation PR Workflow
# 
# This workflow creates attestation markdown files and opens a PR for review.
# It is MANUAL DISPATCH ONLY (opt-in) - attestations are human actions, not software beliefs.
#
# IMPORTANT: Attestations represent human declarations and commitments.
# This workflow facilitates the documentation process but does not create,
# validate, or endorse any attestation content. All attestations must be
# initiated by authorized human actors with proper consent.

name: Create Attestation PR

on:
  workflow_dispatch:
    inputs:
      attestation_type:
        description: 'Type of attestation (identity, professional, faith, custom)'
        required: true
        default: 'identity'
        type: choice
        options:
          - identity
          - professional
          - faith
          - custom
      subject_identifier:
        description: 'Subject identifier (DID or AscendancyID token)'
        required: true
        type: string
      attestation_title:
        description: 'Title for the attestation document'
        required: true
        type: string
      witness_name:
        description: 'Name of the authorized witness/issuer'
        required: true
        type: string
      additional_notes:
        description: 'Additional notes or context (optional)'
        required: false
        type: string

jobs:
  create-attestation-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate attestation document
        id: generate
        run: |
          # Create timestamp and unique ID
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          DATE_SLUG=$(date -u +"%Y%m%d-%H%M%S")
          ATTESTATION_ID="attestation-${DATE_SLUG}-${{ github.run_number }}"
          
          # Create attestations directory if it doesn't exist
          mkdir -p attestations/records
          
          # Generate the attestation markdown file
          cat > "attestations/records/${ATTESTATION_ID}.md" << 'ATTESTATION_EOF'
          # Attestation Record
          
          ## Metadata
          
          | Field | Value |
          |-------|-------|
          | **Attestation ID** | `${{ github.run_id }}-${{ github.run_number }}` |
          | **Type** | ${{ inputs.attestation_type }} |
          | **Subject** | `${{ inputs.subject_identifier }}` |
          | **Title** | ${{ inputs.attestation_title }} |
          | **Witness** | ${{ inputs.witness_name }} |
          | **Created** | ${TIMESTAMP} |
          | **Workflow Run** | [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
          
          ## Important Notice
          
          > âš ï¸ **Human Action Declaration**
          >
          > This attestation represents a human declaration or commitment. It is NOT a software-generated
          > belief or automated assertion. The infrastructure facilitates recording and verification,
          > but all attestations originate from and are the responsibility of human actors.
          >
          > By approving this PR, reviewers confirm that:
          > 1. The attestation was initiated by an authorized human actor
          > 2. Proper consent was obtained from the subject
          > 3. The witness/issuer is authorized to make this attestation
          > 4. The content accurately reflects the human declaration being attested
          
          ## Attestation Content
          
          **Title:** ${{ inputs.attestation_title }}
          
          **Type:** ${{ inputs.attestation_type }}
          
          **Subject Identifier:** `${{ inputs.subject_identifier }}`
          
          **Authorized Witness:** ${{ inputs.witness_name }}
          
          ### Additional Notes
          
          ${{ inputs.additional_notes || '_No additional notes provided._' }}
          
          ## Verification
          
          This attestation record should be:
          1. Reviewed by authorized personnel
          2. Linked to a Verifiable Credential (VC) upon approval
          3. Recorded on-chain via the attestation layer (if applicable)
          
          ## Consent Confirmation
          
          - [ ] Subject has provided informed consent
          - [ ] Witness is authorized to issue this attestation type
          - [ ] All information has been verified for accuracy
          - [ ] Privacy requirements have been satisfied
          
          ---
          
          *Generated by OTAP Attestation Workflow*
          *Part of the OmniTech Ascendancy Protocol*
          ATTESTATION_EOF
          
          # Replace variables in the generated file
          sed -i "s|\${TIMESTAMP}|${TIMESTAMP}|g" "attestations/records/${ATTESTATION_ID}.md"
          
          echo "attestation_id=${ATTESTATION_ID}" >> $GITHUB_OUTPUT
          echo "attestation_file=attestations/records/${ATTESTATION_ID}.md" >> $GITHUB_OUTPUT
          echo "branch_name=attestation/${ATTESTATION_ID}" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs(attestation): Add ${{ inputs.attestation_type }} attestation record"
          title: "ðŸ“œ Attestation: ${{ inputs.attestation_title }}"
          body: |
            ## Attestation Pull Request
            
            This PR was automatically generated by the Attestation Workflow.
            
            ### Details
            
            | Field | Value |
            |-------|-------|
            | **Type** | ${{ inputs.attestation_type }} |
            | **Subject** | `${{ inputs.subject_identifier }}` |
            | **Witness** | ${{ inputs.witness_name }} |
            | **Initiated By** | @${{ github.actor }} |
            
            ### âš ï¸ Important: Human Action Required
            
            **Attestations are human actions, not software beliefs.**
            
            Before merging this PR, reviewers MUST confirm:
            
            - [ ] This attestation was initiated by an authorized human actor
            - [ ] The subject has provided informed, voluntary consent
            - [ ] The witness (${{ inputs.witness_name }}) is authorized for this attestation type
            - [ ] All information in the attestation is accurate and verified
            - [ ] Privacy and ethical guidelines have been followed
            
            ### Review Checklist
            
            - [ ] Attestation content reviewed for accuracy
            - [ ] Consent documentation verified
            - [ ] No sensitive/private information exposed
            - [ ] Follows OTAP attestation guidelines
            
            ---
            
            *This PR was generated by the OTAP Attestation Workflow.*
            *Workflow run: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
          branch: ${{ steps.generate.outputs.branch_name }}
          delete-branch: true
          labels: |
            attestation
            needs-review
            human-action

      - name: Output summary
        run: |
          echo "## Attestation PR Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Attestation ID:** ${{ steps.generate.outputs.attestation_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **File:** ${{ steps.generate.outputs.attestation_file }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ steps.generate.outputs.branch_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> âš ï¸ **Reminder:** Attestations are human actions. Please ensure proper review before merging." >> $GITHUB_STEP_SUMMARY
