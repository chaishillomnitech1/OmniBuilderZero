name: NFT Metadata Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'phase2/nft_development/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'phase2/nft_development/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-metadata-schemas:
    name: Validate NFT Metadata Schemas
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install JSON Schema validator
        run: npm install -g ajv-cli
      
      - name: Check metadata directory structure
        run: |
          mkdir -p phase2/nft_development/metadata/schemas
          mkdir -p phase2/nft_development/metadata/examples
          mkdir -p phase2/nft_development/metadata/templates
          echo "âœ… Metadata directory structure verified"
      
      - name: Validate JSON schemas (if present)
        run: |
          if [ -n "$(find phase2/nft_development/metadata -name '*.json' 2>/dev/null)" ]; then
            for schema in phase2/nft_development/metadata/schemas/*.json; do
              if [ -f "$schema" ]; then
                echo "Validating schema: $schema"
                python3 -m json.tool "$schema" > /dev/null
              fi
            done
            echo "âœ… All schemas validated"
          else
            echo "â„¹ï¸  No metadata schemas found yet (expected for initial setup)"
          fi
      
      - name: Validate example metadata (if present)
        run: |
          if [ -n "$(find phase2/nft_development/metadata/examples -name '*.json' 2>/dev/null)" ]; then
            for example in phase2/nft_development/metadata/examples/*.json; do
              if [ -f "$example" ]; then
                echo "Validating example: $example"
                python3 -m json.tool "$example" > /dev/null
              fi
            done
            echo "âœ… All examples validated"
          else
            echo "â„¹ï¸  No example metadata found yet (expected for initial setup)"
          fi
  
  validate-smart-contracts:
    name: Validate Smart Contract Structure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Check smart contract directory
        run: |
          mkdir -p phase2/nft_development/smart_contracts
          mkdir -p phase2/nft_development/smart_contracts/interfaces
          echo "âœ… Smart contract directory structure verified"
      
      - name: Validate Solidity files (if present)
        run: |
          if [ -n "$(find phase2/nft_development/smart_contracts -name '*.sol' 2>/dev/null)" ]; then
            echo "Found Solidity files - would run solc validation here"
            # In future: npm install -g solc && solc --version
            echo "âœ… Solidity validation would run here"
          else
            echo "â„¹ï¸  No Solidity contracts found yet (expected for initial setup)"
          fi
  
  validate-deployment-scripts:
    name: Validate Deployment Scripts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Check deployment scripts directory
        run: |
          mkdir -p phase2/nft_development/deployment_scripts
          echo "âœ… Deployment scripts directory verified"
      
      - name: Validate JavaScript deployment scripts (if present)
        run: |
          if [ -n "$(find phase2/nft_development/deployment_scripts -name '*.js' 2>/dev/null)" ]; then
            for script in phase2/nft_development/deployment_scripts/*.js; do
              if [ -f "$script" ]; then
                echo "Checking syntax: $script"
                node --check "$script"
              fi
            done
            echo "âœ… All deployment scripts validated"
          else
            echo "â„¹ï¸  No deployment scripts found yet (expected for initial setup)"
          fi
  
  check-documentation:
    name: Verify NFT Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Check README exists
        run: |
          test -f phase2/nft_development/README.md
          echo "âœ… NFT development README found"
      
      - name: Verify key sections in README
        run: |
          grep -q "Guardian NFT" phase2/nft_development/README.md
          grep -q "Smart Contract" phase2/nft_development/README.md
          grep -q "Metadata" phase2/nft_development/README.md
          echo "âœ… README contains required sections"
      
      - name: Check for example contract addresses
        run: |
          # Warn if mainnet addresses found (should be in config, not docs)
          if grep -r "0x[a-fA-F0-9]\{40\}" phase2/nft_development/README.md | grep -v "0x\.\.\." > /dev/null; then
            echo "âš ï¸  Warning: Found specific addresses in documentation"
          else
            echo "âœ… No hardcoded addresses in documentation"
          fi
  
  integration-readiness:
    name: Check Integration Readiness
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Check cross-references
        run: |
          # Verify NFT development references other components
          grep -q "emissary_bots" phase2/nft_development/README.md || echo "âš ï¸  Consider adding emissary_bots integration reference"
          grep -q "star_dust" phase2/nft_development/README.md || echo "âš ï¸  Consider adding star_dust integration reference"
          grep -q "blockchain_integration" phase2/nft_development/README.md || echo "âš ï¸  Consider adding blockchain_integration reference"
          echo "âœ… Integration references checked"
  
  summary:
    name: NFT Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-metadata-schemas, validate-smart-contracts, validate-deployment-scripts, check-documentation, integration-readiness]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## NFT Development Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Metadata schemas validated" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Smart contract structure verified" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployment scripts checked" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Documentation validated" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Integration readiness verified" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ›¡ï¸ Guardian NFT development environment ready!" >> $GITHUB_STEP_SUMMARY
