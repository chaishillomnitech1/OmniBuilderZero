name: OTAP CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  FOUNDRY_PROFILE: ci
  NODE_VERSION: '18'

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Solhint
        run: npx solhint 'contracts/**/*.sol' --max-warnings 0
        continue-on-error: true

      - name: Check formatting
        run: npx prettier --check 'contracts/**/*.sol' 'test/**/*.js'
        continue-on-error: true

  compile:
    name: Compile Contracts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Compile with Hardhat
        run: npm run compile

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: hardhat-artifacts
          path: |
            artifacts/
            cache/
          retention-days: 1

  test-hardhat:
    name: Test (Hardhat)
    runs-on: ubuntu-latest
    needs: compile
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: hardhat-artifacts

      - name: Run tests
        run: npm test

      - name: Run coverage
        run: npx hardhat coverage
        continue-on-error: true

  test-foundry:
    name: Test (Foundry)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Forge build
        run: |
          forge --version
          forge build --sizes
        continue-on-error: true

      - name: Run Forge tests
        run: forge test -vvv
        continue-on-error: true

      - name: Run Forge coverage
        run: forge coverage
        continue-on-error: true

  contract-size:
    name: Contract Size Check
    runs-on: ubuntu-latest
    needs: compile
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check contract sizes
        run: npx hardhat size-contracts
        continue-on-error: true

  security:
    name: Security Analysis
    runs-on: ubuntu-latest
    needs: compile
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Slither
        uses: crytic/slither-action@v0.4.0
        continue-on-error: true
        with:
          node-version: ${{ env.NODE_VERSION }}
          sarif: results.sarif
          fail-on: none

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        continue-on-error: true
        with:
          sarif_file: results.sarif

  gas-report:
    name: Gas Report
    runs-on: ubuntu-latest
    needs: compile
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate gas report
        run: REPORT_GAS=true npm test
        continue-on-error: true

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check required documentation
        run: |
          echo "Checking for required documentation files..."
          
          files=(
            "OTAP-README.md"
            "ARCH_EXECUTOR.md"
            "ROADMAP.md"
            "ASCENDANCYID-SPEC.md"
            "README.md"
            "LICENSE"
          )
          
          missing=0
          for file in "${files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing: $file"
              missing=$((missing + 1))
            else
              echo "✅ Found: $file"
            fi
          done
          
          if [ $missing -gt 0 ]; then
            echo "⚠️  $missing documentation file(s) missing"
            exit 1
          fi
          
          echo "✅ All required documentation files present"

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, compile, test-hardhat, test-foundry, contract-size, security, gas-report, documentation]
    if: always()
    steps:
      - name: Check job results
        run: |
          echo "## OTAP CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Compile | ${{ needs.compile.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test (Hardhat) | ${{ needs.test-hardhat.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test (Foundry) | ${{ needs.test-foundry.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Contract Size | ${{ needs.contract-size.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Gas Report | ${{ needs.gas-report.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation | ${{ needs.documentation.result }} |" >> $GITHUB_STEP_SUMMARY
